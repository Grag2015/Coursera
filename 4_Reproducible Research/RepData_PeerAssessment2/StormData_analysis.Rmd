---
title: "Assessment_2"
author: "Grag"
date: "15 ноября 2015 г."
output: html_document
---

setwd("d:/Grag/R/R-studio/Coursera/4_Reproducible Research/RepData_PeerAssessment2/")

## There are negative correlation between frequency and damage of events
Questions
**1**. Across the United States, which types of events are most harmful with respect to population health?
**2**. Across the United States, which types of events have the greatest economic consequences?

## Synopsis 
Мы проанализировал данные за весь период наблюдения. Для каждого типа события мы
нашли общую сумму ущерба, количество событий и средний урон события.
Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences. Лидер Торнадо - столько и столько. На втором месте
 и т.д. Хочется отметить, что есть события с бОльшим средним уроном, чем Торнадо, но они возникают
 гораздо реже - например. И видимо мы еще не научились справляться с такими катаклизами
 именно их надо изучать более детально, учиться их прогнозировать и готовиться к
 ним заранее.

## Data Processing
1. Данные скачал по ссылке [Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) в 
архиве bz2.
2. Read bz2-file
```{r cache=TRUE, message=FALSE}
df <- read.csv(bzfile("./repdata-data-StormData.csv.bz2"))
```

See first 3 transposed rows 
```{r}
t(head(df, n = 3))
```

check NAs for `df`
```{r}
sapply(df, function(e) sum(is.na(e)))
```
There isn't NA-values in interesting columns - EVTYPE, FATALITIES, INJURIES, *DMG

**Thus**, the data are ready for analysis.

## Results
рассчитаем суммарную (FATALtotal and INJURtotal), среднюю (FATALmean and INJURmean)
и количество (EVTYPEn) event for  события
```{r warning=FALSE, message=FALSE}
library(dplyr)
tmp <- group_by(df, EVTYPE)
tmp2 <- summarise(.data=tmp, FATALtotal=sum(FATALITIES), FATALmean=mean(FATALITIES),
                  EVTYPEn=n(), INJURtotal=sum(INJURIES), INJURmean=mean(INJURIES))
# order by FATALtotal
tmp2ord <- tmp2[order(tmp2$FATALtotal, decreasing = T),]
```


Здесь мы видим ТОП-10 events c самым большим суммарным количеством смертей  `FATALtotal`
```{r results='asis'}
library(xtable)
xt <- xtable(head(tmp2ord, n=10))
print(xt, type="html")
```

Next, мы видим ТОП-10 events c самым большим средним количеством смертей `FATALmean`
```{r results='asis'}
library(xtable)
xt <- xtable(head(tmp2[order(tmp2$FATALmean, decreasing = T),], n=10))
print(xt, type="html")
```


##  
Next, create new factor `FATALtotalFac` for `FATALtotal` (It's necessary for plot)
```{r FATALtotal}
tmp2ord$FATALtotalFac <- character(length = nrow(tmp2ord))
tmp2ord[tmp2ord$FATALtotal>=500,]$FATALtotalFac<-"500+" 
tmp2ord[tmp2ord$FATALtotal>=100 & tmp2ord$FATALtotal<500,]$FATALtotalFac<-"100-500" 
tmp2ord[tmp2ord$FATALtotal>=50 & tmp2ord$FATALtotal<100,]$FATALtotalFac<-"50-100" 
tmp2ord[tmp2ord$FATALtotal<50,]$FATALtotalFac<-"0-50" 
tmp2ord$FATALtotalFac <- factor(x=tmp2ord$FATALtotalFac,levels = c("0-50", "50-100",
                                                                   "100-500", "500+"),
                                ordered = T)
```
 

содержит записи с FATALtotal>=50 - для дальнейшего использования на графике
```{r} 
tmp3 <- tmp2ord[tmp2ord$FATALtotalFac!="0-50" & tmp2ord$FATALtotalFac!="50-100",]
tmp3$EVTYPE <- as.character(tmp3$EVTYPE)
tmp3[tmp3$FATALtotalFac=="500+",]$EVTYPE <- paste0(tmp3[tmp3$FATALtotalFac=="500+",]$EVTYPE," (", tmp3[tmp3$FATALtotalFac=="500+",]$FATALtotal, ")")
```

Построим интересный график
```{r fig.width=10,  fig.height=8, warning=FALSE, message=FALSE}
library(ggplot2)

ggplot(data = tmp2ord, aes(x=(FATALmean)^(1/4), y=(EVTYPEn)^(1/4), col=FATALtotalFac, size=(FATALtotal)^(1/4))) + 
    geom_point()+xlim(0,1.5)+
    ylim(0,24)+
    annotate("text", label = tmp3$EVTYPE, x = (tmp3$FATALmean)^(1/4), y = (tmp3$EVTYPEn)^(1/4), size = 3, colour = "#2e3a23",  hjust=-0.1)+
    xlab("Mean fatalities per event, pcs^(1/4)")+
    ylab("Number of events, pcs^(1/4)")+
    labs(title="Relation between 'Mean fatalities per event' and 'Number of events'")+
    scale_size_continuous(breaks=NULL)+
    scale_color_discrete(name="Fatalities levels")

```
как видим существует обратная связь между частотой события и средним ущербом - 
чем чаще появляется событие, тем меньше ущерба оно наносит. Все evets form TOP-10
располагаются ближе к центру графика.

**It's interesting**: positive correlation between FATALtotal and INJURtotal
```{r}
fit <- lm(FATALtotal~INJURtotal, data = tmp2ord)
summary(fit)
```
There is strong correlation between FATALtotal and INJURtotal.
If INJURtotal increased on 100 men then FATALtotal increased on 6 men.


##  
# Mean injuries in time series
```{r warning=FALSE, message=FALSE}
# preparation data for plot
df$BGN_DATE <- as.Date(df$BGN_DATE, "%m/%d/%Y")
library(lubridate)
df$year <- year(df$BGN_DATE)
tmp <- group_by(df, year)
tmp2 <- summarise(.data=tmp, INJURtotal=sum(INJURIES), INJURmean=mean(INJURIES))
#make plot
ggplot(data = tmp2, aes(x=year, y=INJURmean))+geom_line()+geom_smooth()+
    ylab("Mean injuries per event")+
    xlab("Years")+
    labs(title="Mean injuries increase")
    
```

Мы видим, что со временем средние потери падают, это видимо связано, с тем, что
люди научились лучше защищаться от разрушительного воздействия стихии.

Обработка данных  greatest economic consequences
```{r}
Rprof("path_to_hold_output")
df$PROPDMGdoll <- df$PROPDMG
for (i in 1:length(df$PROPDMG)) {
    df$PROPDMGdol[i] <- df$PROPDMG[i]*switch (as.character(df$PROPDMGEXP[i]),
                                K = 10^3, k = 10^3,
                                M = 10^6, m = 10^6,
                                B = 10^9, b = 10^9,
                                1
    )
}
Rprof(NULL)
summaryRprof("path_to_hold_output")
```


