---
title: "Assessment_2"
author: "Grag"
date: "15 ноября 2015 г."
output: html_document
---

setwd("d:/Grag/R/R-studio/Coursera/4_Reproducible Research/RepData_PeerAssessment2/")

## There are negative correlation between frequency and damage of events

## Synopsis 
Мы проанализировал данные за весь период наблюдения. Для каждого типа события мы
нашли общую сумму ущерба, количество событий и средний урон события.
Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

## Data Processing
1. Данные скачал по ссылке [Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) в 
архиве bz2.
2. Read bz2-file
```{r cache=TRUE, message=FALSE}
df <- read.csv(bzfile("./repdata-data-StormData.csv.bz2"))
```
```{r}
t(head(df, n = 3))
```

check NAs for `df`
```{r}
sapply(df, function(e) sum(is.na(e)))
```
There isn't NA-values in interesting columns

Thus, the data are ready for analysis.

## Results
рассчитаем суммарную, среднюю  и количество event for  события
```{r warning=FALSE, message=FALSE}
library(dplyr)
tmp <- group_by(df, EVTYPE)
tmp2 <- summarise(.data=tmp, FATALtotal=sum(FATALITIES), FATALmean=mean(FATALITIES),
                  EVTYPEn=n(), INJURtotal=sum(INJURIES), INJURmean=mean(INJURIES))
# order by 
tmp2ord <- tmp2[order(tmp2$FATALtotal, decreasing = T),]
# check NAs
sapply(tmp2ord, function(e) sum(is.na(e)))
```

```{r}
summary(tmp2ord$FATALtotal)
```


Здесь мы видим ТОП-10 events c самым большим суммарным количеством смертей
```{r results='asis'}
library(xtable)
xt <- xtable(head(tmp2ord, n=10))
print(xt, type="html")
```

create new factor `FATALtotalFac` for `FATALtotal`
```{r FATALtotal}
tmp2ord$FATALtotalFac <- character(length = nrow(tmp2ord))
tmp2ord[tmp2ord$FATALtotal>=500,]$FATALtotalFac<-"500+" 
tmp2ord[tmp2ord$FATALtotal>=100 & tmp2ord$FATALtotal<500,]$FATALtotalFac<-"100-500" 
tmp2ord[tmp2ord$FATALtotal>=50 & tmp2ord$FATALtotal<100,]$FATALtotalFac<-"50-100" 
tmp2ord[tmp2ord$FATALtotal<50,]$FATALtotalFac<-"0-50" 
tmp2ord$FATALtotalFac <- factor(x=tmp2ord$FATALtotalFac,levels = c("0-50", "50-100",
                                                                   "100-500", "500+"),
                                ordered = T)
```

содержит записи с FATALtotal>=50 - для дальнейшего использования на графике
```{r} 
tmp3 <- tmp2ord[tmp2ord$FATALtotalFac!="0-50" & tmp2ord$FATALtotalFac!="50-100",]
tmp3$EVTYPE <- as.character(tmp3$EVTYPE)
tmp3[tmp3$FATALtotalFac=="500+",]$EVTYPE <- paste0(tmp3[tmp3$FATALtotalFac=="500+",]$EVTYPE," (", tmp3[tmp3$FATALtotalFac=="500+",]$FATALtotal, ")")
```

как видим существует обратная связь между частотой события и средним ущербом - 
чем чаще появляется событие, тем меньше ущерба оно наносит
```{r fig.width=10,  fig.height=8, warning=FALSE, message=FALSE}
library(ggplot2)

ggplot(data = tmp2ord, aes(x=(FATALmean)^(1/4), y=(EVTYPEn)^(1/4), col=FATALtotalFac, size=(FATALtotal)^(1/4))) + 
    geom_point()+xlim(0,1.5)+
    ylim(0,24)+
    annotate("text", label = tmp3$EVTYPE, x = (tmp3$FATALmean)^(1/4), y = (tmp3$EVTYPEn)^(1/4), size = 3, colour = "#2e3a23",  hjust=-0.1)+
    xlab("Mean fatalities per event, pcs^(1/4)")+
    ylab("Number of events, pcs^(1/4)")+
    labs(title="Relation between 'Mean fatalities per event' and 'Number of events'")+
    scale_size_continuous(breaks=NULL)+
    scale_color_discrete(name="Fatalities levels")

```

create new factor `INJURtotalFac` for `INJURtotal`
```{r INJURtotal}
tmp2ord$INJURtotalFac <- character(length = nrow(tmp2ord))
tmp2ord[tmp2ord$INJURtotal>=5000,]$INJURtotalFac<-"5000+" 
tmp2ord[tmp2ord$INJURtotal>=1000 & tmp2ord$INJURtotal<5000,]$INJURtotalFac<-"1000-5000" 
tmp2ord[tmp2ord$INJURtotal>=100 & tmp2ord$INJURtotal<1000,]$INJURtotalFac<-"100-1000" 
tmp2ord[tmp2ord$INJURtotal<100,]$INJURtotalFac<-"0-100" 
tmp2ord$INJURtotalFac <- factor(x=tmp2ord$INJURtotalFac,levels = c("0-100", "100-1000",
                                                                   "1000-5000", "5000+"),
                                ordered = T)
```

содержит записи с INJURtotal>=50 - для дальнейшего использования на графике
```{r} 
tmp3 <- tmp2ord[tmp2ord$INJURtotalFac!="0-100" & tmp2ord$INJURtotalFac!="100-1000",]
tmp3$EVTYPE <- as.character(tmp3$EVTYPE)
# for values greater than 5000 add label with 
tmp3[tmp3$INJURtotalFac=="5000+",]$EVTYPE <- paste0(tmp3[tmp3$INJURtotalFac=="5000+",]$EVTYPE,
                                                    " (", tmp3[tmp3$INJURtotalFac=="5000+",]$INJURtotal, ")")
```

как видим существует обратная связь между частотой события и средним ущербом - 
чем чаще появляется событие, тем меньше ущерба оно наносит
```{r fig.width=10,  fig.height=8, warning=FALSE, message=FALSE}

ggplot(data = tmp2ord, aes(x=(INJURmean)^(1/4), y=(EVTYPEn)^(1/4), col=INJURtotalFac, size=(INJURtotal)^(1/4))) + 
    geom_point()+
    xlim(0,3)+
    ylim(0,25)+
    annotate("text", label = tmp3$EVTYPE, x = (tmp3$INJURmean)^(1/4), y = (tmp3$EVTYPEn)^(1/4), size = 3, colour = "#2e3a23",  hjust=-0.1)+
    xlab("Mean injuries per event, pcs^(1/4)")+
    ylab("Number of events, pcs^(1/4)")+
    labs(title="Relation between 'Mean injuries per event' and 'Number of events'")+
    scale_size_continuous(breaks=NULL)+
    scale_color_discrete(name="Injuries levels")

```
